<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CLIC Submissions – Slideshow</title>
  <style>
    :root { --bg:#0b0b0e; --fg:#f5f7fa; --muted:#aab4c6; --panel:#111622; --btn:#1d2332; --btn2:#222a3d; --border:#2a3245; --accent:#4ea1ff; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    .bar{position:fixed;inset:0 0 auto 0;display:flex;gap:12px;align-items:center;padding:10px 14px;background:var(--panel);box-shadow:0 2px 8px rgba(0,0,0,.35);z-index:10}
    .bar h1{margin:0;font-size:16px;font-weight:600;opacity:.95}
    .spacer{flex:1}
    .bar a,.bar button{color:var(--fg);background:var(--btn);border:1px solid var(--border);padding:8px 12px;border-radius:8px;cursor:pointer;text-decoration:none}
    .bar a:hover,.bar button:hover{background:var(--btn2)}
    .wrap{position:fixed;inset:56px 0 64px 0;display:flex;align-items:center;justify-content:center}
    .stage{text-align:center;max-width:92vw;max-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .stage img{max-width:92vw;max-height:72vh;object-fit:contain;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .caption{margin-top:12px;font-size:16px;color:var(--muted)}
    .caption strong{color:#fff}
    .controls{position:fixed;inset:auto 0 12px 0;display:flex;justify-content:center;gap:10px}
    .controls button{background:var(--btn);color:var(--fg);border:1px solid var(--border);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer}
    .controls button:hover{background:var(--btn2)}
    .error{color:#ff8080}
  </style>
</head>
<body>
  <div class="bar">
    <h1>CLIC Submissions – Slideshow</h1>
    <div class="spacer"></div>
    <button id="refreshBtn">Refresh</button>
    <a id="csvLink" href="https://55bfb3f29de3.ngrok-free.app/api/submissions.csv" target="_blank" rel="noopener">Download CSV</a>
  </div>

  <div class="wrap">
    <div class="stage">
      <img id="slide" alt="submission">
      <div id="caption" class="caption">Loading…</div>
    </div>
  </div>

  <div class="controls">
    <button id="prevBtn">◀︎ Previous</button>
    <button id="playBtn">⏸ Pause</button>
    <button id="nextBtn">Next ▶︎</button>
  </div>

  <script>
    // ----- CONFIG -----
    const BACKEND = "https://55bfb3f29de3.ngrok-free.app";
    const FEED    = BACKEND + "/api/submissions";
    const INTERVAL_MS = 5000;

    // ----- STATE -----
    let items = [];
    let idx = 0, timer = null, playing = true;

    const imgEl = document.getElementById("slide");
    const capEl = document.getElementById("caption");

    // Helpful visibility when an image fails to load
    imgEl.addEventListener("error", () => {
      capEl.innerHTML += ` <span class="error">(image not found)</span>`;
    });

    async function load() {
      stop();
      capEl.textContent = "Loading…";
      try {
        const r = await fetch(FEED, { mode:"cors", cache:"no-store" });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();

        const list = Array.isArray(data) ? data : (data.items || []);
        // Build absolute URLs & normalise score types
        items = list.map(row => {
          const abs = new URL(row.image_url, BACKEND).href;
          const scoreNum = Number.parseFloat(row.creativity_score);
          return { ...row, abs_url: abs, creativity_score: Number.isFinite(scoreNum) ? scoreNum : null };
        });

        if (!items.length) {
          capEl.textContent = "No submissions yet.";
          imgEl.removeAttribute("src");
          return;
        }

        // newest first
        items.sort((a,b) => (b.uploaded_at||"").localeCompare(a.uploaded_at||""));

        idx = 0;
        show(idx);
        if (playing) start();
      } catch (e) {
        console.error("Load failed:", e);
        capEl.innerHTML = `<span class="error">Failed to load submissions.</span>`;
        imgEl.removeAttribute("src");
      }
    }

    function show(i) {
      idx = (i + items.length) % items.length;
      const it = items[idx];

      // bust cache in case ngrok/proxy caches aggressively
      const src = it.abs_url + (it.abs_url.includes("?") ? "&" : "?") + "t=" + Date.now();
      imgEl.src = src;

      const id   = it.participant_id ?? "–";
      const when = it.uploaded_at ? ` • ${it.uploaded_at}` : "";
      const fb   = it.used_fallback ? " (fallback)" : "";
      const score = (it.creativity_score == null) ? "–" : it.creativity_score.toFixed(4);

      capEl.innerHTML = `<strong>${id}</strong> — score: <strong>${score}</strong>${fb}${when}`;

      // prefetch next
      const pre = new Image();
      pre.src = items[(idx+1)%items.length].abs_url;
    }

    function next(){ show(idx+1); }
    function prev(){ show(idx-1); }
    function start(){ stop(); playing = true; document.getElementById("playBtn").textContent = "⏸ Pause"; timer = setInterval(next, INTERVAL_MS); }
    function stop(){ playing = false; document.getElementById("playBtn").textContent = "▶︎ Play"; if (timer) clearInterval(timer); timer = null; }
    function toggle(){ playing ? stop() : start(); }

    document.getElementById("refreshBtn").addEventListener("click", load);
    document.getElementById("nextBtn").addEventListener("click", () => { stop(); next(); });
    document.getElementById("prevBtn").addEventListener("click", () => { stop(); prev(); });
    document.getElementById("playBtn").addEventListener("click", toggle);
    window.addEventListener("keydown", e => {
      if (e.code === "ArrowRight") { stop(); next(); }
      else if (e.code === "ArrowLeft") { stop(); prev(); }
      else if (e.code === "Space") { e.preventDefault(); toggle(); }
    });

    load();
  </script>
</body>
</html>
