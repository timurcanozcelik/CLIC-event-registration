<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CLIC Submissions – Slideshow</title>
  <style>
    :root { --bg:#0b0b0e; --fg:#f5f7fa; --accent:#4ea1ff; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .bar {
      position:fixed; top:0; left:0; right:0;
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; background:#111622; box-shadow:0 2px 8px rgba(0,0,0,.35);
      z-index:10;
    }
    .bar h1 { font-size:16px; margin:0; font-weight:600; opacity:.9; }
    .bar .spacer { flex:1; }
    .bar a, .bar button {
      color:var(--fg); background:#1d2332; border:1px solid #2a3245;
      padding:8px 12px; border-radius:8px; cursor:pointer; text-decoration:none; font-size:14px;
    }
    .bar button:hover, .bar a:hover { background:#222a3d; }
    .wrap { position:fixed; inset:56px 0 0 0; display:flex; align-items:center; justify-content:center; }
    .stage { text-align:center; max-width:92vw; max-height:86vh; }
    .stage img {
      max-width:92vw; max-height:72vh; width:auto; height:auto;
      object-fit:contain; background:#fff; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .caption { margin-top:12px; font-size:16px; opacity:.95; }
    .caption strong { color:#fff; }
    .controls {
      position:fixed; bottom:18px; left:0; right:0; display:flex; justify-content:center; gap:10px;
    }
    .controls button {
      background:#1d2332; color:var(--fg); border:1px solid #2a3245;
      padding:10px 14px; border-radius:10px; font-size:15px; cursor:pointer;
    }
    .controls button:hover { background:#222a3d; }
    .muted { opacity:.65; }
  </style>
</head>
<body>
  <div class="bar">
    <h1>CLIC Submissions – Slideshow</h1>
    <div class="spacer"></div>
    <button id="refreshBtn">Refresh</button>
    <a id="csvLink" href="#" target="_blank" rel="noopener">Download CSV</a>
  </div>

  <div class="wrap">
    <div class="stage">
      <img id="slide" alt="submission" />
      <div id="caption" class="caption muted">Loading…</div>
    </div>
  </div>

  <div class="controls">
    <button id="prevBtn">◀︎ Previous</button>
    <button id="playBtn">⏸ Pause</button>
    <button id="nextBtn">Next ▶︎</button>
  </div>

  <script>
    // ---- CONFIG ----
    const BACKEND_BASE = "https://55bfb3f29de3.ngrok-free.app";
    const FEED_JSON    = BACKEND_BASE + "/api/submissions";
    const FEED_CSV     = BACKEND_BASE + "/api/submissions.csv";
    document.getElementById("csvLink").href = FEED_CSV;

    // ---- STATE ----
    let items = []; // normalized: { participant_id, creativity_score, uploaded_at, used_fallback, abs_url }
    let idx = 0, playing = true, timer = null;
    const INTERVAL_MS = 5000;

    const imgEl = document.getElementById("slide");
    const capEl = document.getElementById("caption");

    // ---- LOADERS ----
    async function loadFeed() {
      capEl.textContent = "Loading…";
      items = [];
      try {
        // try JSON first
        const r = await fetch(FEED_JSON, { cache: "no-store" });
        if (r.ok) {
          const data = await r.json();
          const list = Array.isArray(data) ? data : (data.items || []);
          items = list.map(row => ({
            participant_id: row.participant_id ?? "—",
            creativity_score: Number(row.creativity_score ?? NaN),
            uploaded_at: row.uploaded_at ?? "",
            used_fallback: !!row.used_fallback,
            abs_url: BACKEND_BASE + row.image_url
          }));
        } else {
          // fall back to CSV
          await loadFromCSV();
        }
      } catch (e) {
        // if JSON parsing/network failed, try CSV as well
        await loadFromCSV();
      }

      if (!items.length) {
        capEl.textContent = "No submissions yet.";
        imgEl.removeAttribute("src");
        stop();
        return;
      }

      idx = 0;
      show(idx);
      if (playing) start();
    }

    async function loadFromCSV() {
      try {
        const rcsv = await fetch(FEED_CSV, { cache: "no-store" });
        if (!rcsv.ok) throw new Error(rcsv.statusText);
        const text = await rcsv.text();
        items = parseCSV(text).map(row => {
          // Expect either image_url, or (participant_id + filename)
          const image_url = row.image_url ||
                            `/submission/${row.participant_id}/${row.filename}`;
          return {
            participant_id: row.participant_id || "—",
            creativity_score: Number(row.creativity_score ?? row.score ?? NaN),
            uploaded_at: row.uploaded_at || row.time || "",
            used_fallback: (row.used_fallback === "True" || row.used_fallback === "true"),
            abs_url: BACKEND_BASE + image_url
          };
        });
      } catch (e) {
        console.error("CSV load failed:", e);
        capEl.textContent = "Failed to load submissions.";
        stop();
      }
    }

    // minimal CSV parser (handles simple, non-quoted CSV)
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const headers = lines[0].split(",").map(h => h.trim());
      return lines.slice(1).map(line => {
        const cols = line.split(",").map(c => c.trim());
        const obj = {};
        headers.forEach((h,i) => obj[h] = cols[i]);
        return obj;
      });
    }

    // ---- SLIDESHOW ----
    function show(i) {
      idx = (i + items.length) % items.length;
      const it = items[idx];
      imgEl.src = it.abs_url;
      const s = Number.isFinite(it.creativity_score) ? it.creativity_score.toFixed(4) : "—";
      const when = it.uploaded_at ? ` • ${it.uploaded_at}` : "";
      const fb = it.used_fallback ? " (fallback)" : "";
      capEl.innerHTML = `<strong>${it.participant_id}</strong> — score: <strong>${s}</strong>${fb}${when}`;
      capEl.classList.remove("muted");
      const pre = new Image();
      pre.src = items[(idx+1)%items.length].abs_url;
    }
    function next(){ show(idx+1); }
    function prev(){ show(idx-1); }
    function start(){ stop(); playing=true; document.getElementById("playBtn").textContent="⏸ Pause"; timer=setInterval(next,INTERVAL_MS); }
    function stop(){ playing=false; document.getElementById("playBtn").textContent="▶︎ Play"; if(timer) clearInterval(timer); timer=null; }
    function togglePlay(){ playing?stop():start(); }

    // ---- UI ----
    document.getElementById("refreshBtn").addEventListener("click", loadFeed);
    document.getElementById("nextBtn").addEventListener("click", () => { stop(); next(); });
    document.getElementById("prevBtn").addEventListener("click", () => { stop(); prev(); });
    document.getElementById("playBtn").addEventListener("click", togglePlay);
    window.addEventListener("keydown", e => {
      if (e.code==="ArrowRight"){ stop(); next(); }
      else if (e.code==="ArrowLeft"){ stop(); prev(); }
      else if (e.code==="Space"){ e.preventDefault(); togglePlay(); }
    });

    loadFeed();
  </script>
</body>
</html>
