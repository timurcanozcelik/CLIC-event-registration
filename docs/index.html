<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- lock zoom/scroll on mobile -->
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>CLIC Event Registration – Figural Task</title>
  <style>
    :root { --accent:#007aff; }

    html, body {
      margin:0; padding:0;
      height:100%; width:100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:#f9f9f9;
      display:flex; flex-direction:column;
      overflow:hidden;                /* prevent page scroll */
      overscroll-behavior:none;
      touch-action:manipulation;      /* reduce unintended gestures */
    }

    /* screens are full-viewport; only one visible at a time */
    .screen { position:fixed; inset:0; display:none; }
    .show   { display:flex !important; }

    /* 1) WELCOME */
    #welcome {
      background:#fff;
      flex-direction:column; gap:16px;
      align-items:center; justify-content:center;
      padding:24px; text-align:center;
    }
    #welcome h1 { font-size:1.8rem; margin:0; }
    #welcome p  { font-size:1.05rem; color:#555; margin:0; }
    #welcome input {
      font-size:1rem; padding:10px 12px; width:80%; max-width:320px;
      border:1px solid #ccc; border-radius:6px;
    }
    #welcome button {
      margin-top:6px;
      font-size:1.1rem; padding:12px 20px;
      background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer;
    }

    /* 2) APP (header + canvas + controls) */
    #app { flex-direction:column; background:#f9f9f9; }

    #header {
      padding:14px 16px; background:#fff;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
    }
    #header h2 { margin:0 0 6px; font-size:1.4rem; }
    #header p  { margin:0; color:#555; }

    #canvasContainer {
      flex:1;
      display:flex; align-items:center; justify-content:center;
      padding:8px;
      overflow:hidden; /* no internal scrolling */
    }
    #drawingCanvas {
      width:90vw; height:70vh;
      max-width:600px; max-height:800px;
      border:2px solid #d0d0d0; background:#fff;
      border-radius:8px;
      touch-action:none; /* disable panning/zoom on canvas */
    }

    #controls {
      padding:12px 16px; background:#fff;
      box-shadow:0 -1px 4px rgba(0,0,0,0.08);
      display:flex; flex-direction:column; gap:10px; align-items:center;
    }
    #controls button {
      width:90%; max-width:320px;
      padding:14px 0; font-size:1.15rem; border:none; border-radius:8px; cursor:pointer;
    }
    #clearBtn { background:#eee; color:#333; }
    #submitBtn{ background:var(--accent); color:#fff; }
    #status   { color:#555; font-size:1rem; min-height:1.2em; }

    /* 3) SUMMARY */
    #summary {
      background:#fff;
      flex-direction:column; align-items:center; justify-content:center;
      text-align:center; padding:24px; gap:8px;
    }
    #summary h2 { font-size:2rem; margin:0 0 8px; }
    #summary p  { font-size:1.1rem; margin:4px 0; }
    #summary a  { color:var(--accent); text-decoration:none; font-weight:600; }
  </style>
</head>
<body>

  <!-- 1) WELCOME -->
  <section id="welcome" class="screen">
    <h1>Welcome to the event</h1>
    <p><em>“Enhancing cognitive flexibility: CLIC(k)ing into lifelong learning”</em></p>
    <p>Write your name and press Start Registration to begin.</p>
    <input id="welcomeName" type="text" placeholder="Your name"/>
    <button id="welcomeBtn">Start Registration</button>
  </section>

  <!-- 2) APP (Drawing) -->
  <section id="app" class="screen">
    <div id="header">
      <h2>CLIC Event Registration – Figural Task</h2>
      <p>Finish the incomplete figure however you like. Be creative!</p>
    </div>

    <div id="canvasContainer">
      <canvas id="drawingCanvas"></canvas>
    </div>

    <div id="controls">
      <button id="clearBtn">Clear</button>
      <button id="submitBtn">Submit</button>
      <div id="status"></div>
    </div>
  </section>

  <!-- Template and offscreen preprocess canvas -->
  <img id="template" src="FigureTemplate.png" alt="" style="display:none;" />
  <canvas id="uploadCanvas" width="224" height="224" style="display:none;"></canvas>

  <!-- 3) SUMMARY -->
  <section id="summary" class="screen">
    <h2>All Done!</h2>
    <p>Creativity Score: <span id="finalCreativity">–</span></p>
    <p><a href="https://www.cares.cam.ac.uk/events-single/?postid=5614&event-single" target="_blank" rel="noopener">Back to the event page</a></p>
  </section>

  <script>
    // ===== State machine: ensure we ONLY show the right screen =====
    const screens = {
      welcome: document.getElementById('welcome'),
      app:     document.getElementById('app'),
      summary: document.getElementById('summary'),
    };
    function show(which) {
      Object.values(screens).forEach(el => el.classList.remove('show'));
      screens[which].classList.add('show');
    }
    // Start on welcome, regardless of any cached styles
    document.addEventListener('DOMContentLoaded', () => show('welcome'));

    // ===== Config =====
    const UPLOAD_URL = 'https://55bfb3f29de3.ngrok-free.app/upload/';

    // ===== Welcome flow =====
    let participantName = '';
    document.getElementById('welcomeBtn').addEventListener('click', () => {
      const nm = document.getElementById('welcomeName').value.trim();
      if (!nm) { alert('Please enter your name.'); return; }
      participantName = nm;
      show('app');
      if (template.complete) resizeCanvas();
    });

    // ===== Drawing setup =====
    const canvas    = document.getElementById('drawingCanvas');
    const ctx       = canvas.getContext('2d', { alpha: false });
    const template  = document.getElementById('template');
    const statusEl  = document.getElementById('status');
    const upCan     = document.getElementById('uploadCanvas');
    const upCtx     = upCan.getContext('2d');

    function resizeCanvas() {
      canvas.width  = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      if (template.complete) {
        ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
      }
      ctx.lineWidth = 3;
      ctx.lineCap   = 'round';
      ctx.strokeStyle = '#000';
    }
    window.addEventListener('resize', () => {
      if (screens.app.classList.contains('show')) resizeCanvas();
    });
    template.onload = () => { if (screens.app.classList.contains('show')) resizeCanvas(); };

    // Single-pointer guard to avoid multi-touch thick lines
    let activePointer = null;
    let drawing = false;

    // extra safety: block multi-touch scroll/pinch on iOS
    window.addEventListener('touchmove', (e) => {
      if (e.touches.length > 1) e.preventDefault();
    }, { passive:false });

    canvas.addEventListener('pointerdown', (e) => {
      e.preventDefault();                // stop gesture/pan
      if (activePointer !== null) return; // ignore additional fingers
      activePointer = e.pointerId;
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }, { passive:false });

    canvas.addEventListener('pointermove', (e) => {
      if (e.pointerId !== activePointer || !drawing) return;
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    });

    function endPointer(e) {
      if (e.pointerId === activePointer) {
        drawing = false;
        activePointer = null;
      }
    }
    canvas.addEventListener('pointerup', endPointer);
    canvas.addEventListener('pointerleave', endPointer);
    canvas.addEventListener('pointercancel', endPointer);

    document.getElementById('clearBtn').addEventListener('click', () => {
      statusEl.textContent = '';
      resizeCanvas();
    });

    // ===== Submit =====
    let creativityScore = 0;
    document.getElementById('submitBtn').addEventListener('click', async () => {
      if (!participantName) { alert('Name missing—please restart.'); return; }
      statusEl.textContent = 'Processing…';

      // Compose & invert to 224×224 for AuDrA
      upCtx.clearRect(0, 0, 224, 224);
      if (template.complete) upCtx.drawImage(template, 0, 0, 224, 224);
      upCtx.drawImage(canvas, 0, 0, 224, 224);

      const img = upCtx.getImageData(0, 0, 224, 224);
      const d = img.data;
      for (let i = 0; i < d.length; i += 4) {
        d[i]   = 255 - d[i];
        d[i+1] = 255 - d[i+1];
        d[i+2] = 255 - d[i+2];
      }
      upCtx.putImageData(img, 0, 0);

      upCan.toBlob(async (blob) => {
        if (!blob) { statusEl.textContent = 'Capture failed'; return; }
        const form = new FormData();
        form.append('participant_id', participantName);
        form.append('file', blob, 'drawing.png');

        statusEl.textContent = 'Uploading…';
        try {
          const resp = await fetch(UPLOAD_URL, { method: 'POST', body: form });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data?.note || resp.statusText);
          creativityScore = data.creativity_score;

          // Only after a successful upload: show Summary
          document.getElementById('finalCreativity').textContent =
            String(Math.round(creativityScore * 10000) / 10000);
          show('summary');
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Network error';
        }
      }, 'image/png');
    });

    // Belt-and-suspenders: block browser pinch-zoom gesture events
    document.addEventListener('gesturestart',  e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend',    e => e.preventDefault());
  </script>
</body>
</html>
