<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TTCT Figural ＋ Stroop</title>
  <style>
    html,body {
      margin:0; padding:0;
      height:100%; width:100%;
      display:flex; flex-direction:column;
      font-family:sans-serif;
      background:#f9f9f9;
    }
    /* Drawing header */
    #header {
      padding:16px;
      background:#fff;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }
    #header h1 { margin:0 0 8px; font-size:1.75rem; }
    #header p  { margin:0 0 12px; color:#555; font-size:1.1rem; }
    #header label { display:block; margin-bottom:8px; font-size:1rem; }
    #header input {
      width:100%; max-width:280px;
      padding:8px 10px; font-size:1rem;
    }

    /* Visible canvas */
    #canvasContainer {
      flex:1;
      display:flex; justify-content:center; align-items:center;
      padding:8px; overflow:auto;
    }
    #drawingCanvas {
      width:90vw; height:70vh;
      max-width:600px; max-height:800px;
      border:2px solid #ccc;
      background:#fff;
      touch-action:none;
    }

    /* Controls */
    #controls {
      padding:12px;
      background:#fff;
      box-shadow:0 -1px 4px rgba(0,0,0,0.1);
      display:flex; flex-direction:column; align-items:center; gap:12px;
    }
    #controls button {
      width:90%; max-width:300px;
      padding:14px 0; font-size:1.2rem;
      border:none; border-radius:6px;
      cursor:pointer;
    }
    #clearBtn { background:#f0f0f0; color:#333; }
    #submitBtn{ background:#007aff; color:#fff; }
    #status   { margin-top:4px; color:#555; font-size:1rem; }

    /* Stroop overlays */
    #stroopInstructions, #stroopContainer {
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.85);
      color:#fff;
      display:none;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:24px;
      text-align:center;
      z-index:10;
    }
    #stroopInstructions h2 {
      font-size:2.25rem; margin-bottom:16px;
    }
    #stroopInstructions p {
      max-width:600px; line-height:1.5; margin-bottom:16px;
      font-size:1.1rem;
    }
    #stroopInstructions button {
      padding:12px 20px; font-size:1.1rem;
      background:#007aff; color:#fff;
      border:none; border-radius:6px; cursor:pointer;
    }

    #stroopContainer h2 { font-size:2rem; margin-bottom:8px; }
    #stroopStatus { margin-bottom:16px; font-size:1.1rem; }
    #stroopStim { font-size:3rem; margin:16px; }

    /* 2×2 grid for Stroop buttons */
    #stroopButtons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      width:90%; max-width:400px;
      margin-bottom:16px;
    }
    #stroopButtons button {
      padding:14px 0; font-size:1.2rem;
      border:none; border-radius:6px; cursor:pointer;
      color:#fff;
    }
    #stroopFeedback { font-size:1.3rem; margin-top:8px; }
  </style>
</head>
<body>

  <!-- Drawing UI -->
  <div id="header">
    <h1>CLIC Event Registration</h1>
    <p>Finish the incomplete figure however you like. Be creative!</p>
    <label>
      Your Name:<br/>
      <input type="text" id="participantId" placeholder="Enter your name"/>
    </label>
  </div>
  <div id="canvasContainer">
    <canvas id="drawingCanvas"></canvas>
  </div>
  <div id="controls">
    <button id="clearBtn">Clear</button>
    <button id="submitBtn">Submit</button>
    <div id="status"></div>
  </div>

  <!-- Hidden template & offscreen upload canvas -->
  <img id="template" src="FigureTemplate.png" style="display:none"/>
  <canvas id="uploadCanvas" width="224" height="224" style="display:none"></canvas>

  <!-- Stroop instructions -->
  <div id="stroopInstructions">
    <h2>
      <span style="color:red">S</span>
      <span style="color:green">t</span>
      <span style="color:blue">r</span>
      <span style="color:yellow">o</span>
      <span style="color:red">o</span>
      <span style="color:green">p</span> Task Instructions
    </h2>
    <hr style="width:80%;border-color:#fff70"/>
    <p>
      You will see colour names printed in a different ink colour.
      <strong>Click the button matching the <em>ink colour</em>, not the word.</strong>
    </p>
    <p style="font-style:italic;">
      Example: see 
      <span style="font-size:2rem;color:red;font-weight:bold;">GREEN</span>,
      click <strong>RED</strong>.
    </p>
    <button id="startStroopBtn">Continue to Task →</button>
  </div>

  <!-- Stroop trials -->
  <div id="stroopContainer">
    <h2>Colour–Word Task</h2>
    <div id="stroopStatus">Trial 1 / 24</div>
    <div id="stroopStim">READY?</div>
    <div id="stroopButtons"></div>
    <div id="stroopFeedback"></div>
  </div>

  <script>
  // — Drawing + upload setup —
    const UPLOAD_URL  = 'https://55bfb3f29de3.ngrok-free.app/upload/';
    const canvas      = document.getElementById('drawingCanvas');
    const ctx         = canvas.getContext('2d');
    const template    = document.getElementById('template');
    const status      = document.getElementById('status');
    const uploadCan   = document.getElementById('uploadCanvas');
    const uploadCtx   = uploadCan.getContext('2d');

    function resizeCanvas(){
      canvas.width  = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      ctx.drawImage(template,0,0,canvas.width,canvas.height);
      ctx.lineWidth   = 2;
      ctx.lineCap     = 'round';
      ctx.strokeStyle = 'black';
    }
    window.addEventListener('resize', resizeCanvas);
    template.onload = resizeCanvas;
    if(template.complete) resizeCanvas();

    let drawing=false;
    canvas.addEventListener('pointerdown',e=>{
      drawing=true; ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY);
    });
    canvas.addEventListener('pointermove',e=>{
      if(!drawing) return;
      ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke();
    });
    ['pointerup','pointerleave'].forEach(evt=>
      canvas.addEventListener(evt,()=>drawing=false)
    );
    document.getElementById('clearBtn').onclick = ()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(template,0,0,canvas.width,canvas.height);
      status.textContent='';
    };

    document.getElementById('submitBtn').onclick = async ()=>{
      const name = document.getElementById('participantId').value.trim();
      if(!name){
        status.textContent='Please enter your name.'; return;
      }
      status.textContent='Processing…';

      // 1) Draw & invert onto hidden 224×224
      uploadCtx.clearRect(0,0,224,224);
      uploadCtx.drawImage(template,       0,0,224,224);
      uploadCtx.drawImage(canvas,         0,0,224,224);
      const imgData = uploadCtx.getImageData(0,0,224,224);
      const d = imgData.data;
      for(let i=0;i<d.length;i+=4){
        // invert RGB
        d[i]   = 255 - d[i];
        d[i+1] = 255 - d[i+1];
        d[i+2] = 255 - d[i+2];
      }
      uploadCtx.putImageData(imgData,0,0);

      // 2) Blob & send
      uploadCan.toBlob(async blob=>{
        if(!blob){ status.textContent='Capture failed'; return; }
        const form = new FormData();
        form.append('participant_id',name);
        form.append('file', blob, 'drawing.png');
        status.textContent='Uploading…';
        try{
          const resp = await fetch(UPLOAD_URL, {method:'POST', body:form});
          const data = await resp.json();
          if(resp.ok){
            status.textContent = `Score: ${data.creativity_score}`;
            startStroop();
          } else {
            status.textContent = `Error: ${data.note||resp.status}`;
          }
        }catch(err){
          console.error(err);
          status.textContent='Network error';
        }
      }, 'image/png');
    };

  // — Stroop setup —
    const COLORS=["red","green","blue","yellow"];
    const WORDS =["RED","GREEN","BLUE","YELLOW"];
    let trials=[], current=0, startTime, results=[];

    (()=>{
      const cong=[], incong=[];
      // 12 congruent, 12 incongruent
      for(let i=0;i<4;i++){
        for(let r=0;r<3;r++) cong.push({w:WORDS[i],c:COLORS[i]});
        for(let j=0;j<4;j++) if(i!==j) incong.push({w:WORDS[i],c:COLORS[j]});
      }
      shuffle(cong); shuffle(incong);
      trials = cong.concat(incong.slice(0,12));
      shuffle(trials);
    })();
    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
    }

    const instrDiv = document.getElementById("stroopInstructions");
    const startBtn = document.getElementById("startStroopBtn");
    const trialDiv = document.getElementById("stroopContainer");
    const stimEl   = document.getElementById("stroopStim");
    const btnsDiv  = document.getElementById("stroopButtons");
    const statusEl = document.getElementById("stroopStatus");
    const feedEl   = document.getElementById("stroopFeedback");

    COLORS.forEach(col=>{
      const b=document.createElement("button");
      b.textContent=col.toUpperCase();
      b.style.background=col;
      b.style.color=(col==='yellow'?'#333':'#fff');
      b.onclick=()=>recordResponse(col);
      btnsDiv.appendChild(b);
    });

    function startStroop(){
      instrDiv.style.display='flex';
    }
    startBtn.onclick = ()=>{
      instrDiv.style.display='none';
      trialDiv.style.display='flex';
      current=0; results=[];
      nextTrial();
    };

    function nextTrial(){
      if(current>=trials.length) return finishStroop();
      const t=trials[current];
      stimEl.textContent=t.w;
      stimEl.style.color=t.c;
      statusEl.textContent=`Trial ${current+1} / ${trials.length}`;
      feedEl.textContent='';
      startTime=performance.now();
    }

    function recordResponse(chosen){
      const t=trials[current];
      const rt=Math.round(performance.now()-startTime);
      results.push({...t,chosen,correct:t.c===chosen,rt});
      feedEl.textContent=(t.c===chosen?'✔️':'❌');
      current++;
      setTimeout(nextTrial,300);
    }

    function finishStroop(){
      stimEl.textContent='All done!';
      statusEl.textContent='';
      const avg = Math.round(results.reduce((s,r)=>s+r.rt,0)/results.length);
      const acc = Math.round(results.filter(r=>r.correct).length/results.length*100);
      feedEl.innerHTML=`
        <strong>Avg RT:</strong> ${avg} ms<br>
        <strong>Accuracy:</strong> ${acc}%`;
      console.log('Stroop results:',results);
      // later: POST `results` + creativity_score to backend for CSV
    }
  </script>
</body>
</html>
